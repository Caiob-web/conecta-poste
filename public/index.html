<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Postes</title>

    <!-- Favicon -->
    <link
      rel="icon"
      href="https://cdn.glitch.global/f333e829-c383-4385-9e81-43a47d865216/ChatGPT%20Image%2019%20de%20jun.%20de%202025%2C%2021_12_44.png?v=1750378383582"
      type="image/png"
      sizes="64x64"
    />

    <!-- Leaflet & MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />

    <!-- FontAwesome para ícones -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      /* --- RESET & MAPA --- */
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }

      /* --- PAINEL DE BUSCA --- */
      .painel-busca {
        position: absolute;
        top: 80px;
        right: 20px;
        width: 280px;
        background: #fff;
        border-left: 4px solid #0055a5;
        border-radius: 6px;
        padding: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        font-family: "Segoe UI", sans-serif;
        z-index: 1000;
      }
      /* ... todo o seu CSS original sem alterações ... */
    </style>
  </head>

  <body>
    <!-- Botões de topo -->
    <div id="togglePainel" class="botao-topo" title="Esconder/Mostrar painel">
      <i class="fa fa-sliders"></i>
    </div>
    <div id="localizacaoUsuario" class="botao-topo" title="Minha localização">
      <i class="fa fa-location-dot"></i>
    </div>
    <div id="logoutBtn" class="botao-topo" title="Logout">
      <i class="fa fa-sign-out-alt"></i>
    </div>

    <!-- Painel de busca -->
    <div class="painel-busca" id="painelBusca">
      <h3>Buscar Postes</h3>
      <!-- ... todos os campos e botões originais sem alterações ... -->
    </div>

    <!-- Legenda -->
    <div class="legenda">
      <!-- ... conteúdo original ... -->
    </div>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- Widget de hora & clima -->
    <div id="widget-clima">
      <!-- ... conteúdo original ... -->
    </div>

    <!-- Spinner de carregamento -->
    <div id="carregando" class="overlay-loading" style="display: flex">
      <!-- ... conteúdo original ... -->
    </div>

    <!-- JS Externos Originais -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- 1) Adicionamos o SheetJS logo antes do seu script.js -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Seu script principal -->
    <script src="script.js"></script>

    <!-- jsPDF e leaflet-image originais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

    <!-- Logout handler original -->
    <script>
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          await fetch("/logout", { method: "POST" });
          window.location.href = "/login.html";
        });
    </script>

    <!-- 2) Novo bloco extra de geração de Excel no cliente -->
    <script>
      // Gera Excel direto no navegador usando SheetJS
      function gerarExcelCliente(filtroIds) {
        const dadosParaExcel = todosPostes
          .filter((p) => filtroIds.includes(p.id))
          .map((p) => ({
            "ID POSTE": p.id,
            Município: p.nome_municipio,
            Bairro: p.nome_bairro,
            Logradouro: p.nome_logradouro,
            Empresas: p.empresas.join(", "),
            Coordenadas: p.coordenadas,
          }));

        const ws = XLSX.utils.json_to_sheet(dadosParaExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Filtro");
        XLSX.writeFile(wb, "relatorio_filtrado.xlsx");
      }

      // “Monkey-patch” da sua filtrarLocal para também gerar Excel
      const _origFiltrarLocal = filtrarLocal;
      filtrarLocal = function () {
        _origFiltrarLocal();

        // Reconstrói o filtro idêntico ao interno
        const mun = document.getElementById("busca-municipio").value.trim().toLowerCase();
        const bai = document.getElementById("busca-bairro").value.trim().toLowerCase();
        const log = document.getElementById("busca-logradouro").value.trim().toLowerCase();
        const emp = document.getElementById("busca-empresa").value.trim().toLowerCase();

        const filtro = todosPostes.filter((p) =>
          (!mun || p.nome_municipio.toLowerCase() === mun) &&
          (!bai || p.nome_bairro.toLowerCase() === bai) &&
          (!log || p.nome_logradouro.toLowerCase() === log) &&
          (!emp || p.empresas.join(", ").toLowerCase().includes(emp))
        );

        if (filtro.length) {
          const ids = filtro.map((p) => p.id);
          gerarExcelCliente(ids);
        }
      };
    </script>
  </body>
</html>
